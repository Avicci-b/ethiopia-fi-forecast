name: Python Tests

on:
  push:
    branches: [ main, task-* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10"]

    steps:
    - uses: actions/checkout@v3  # Changed from @v4 to @v3 (stable version)
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test data loading and basic structure
      run: |
        python -c "
        import pandas as pd
        import sys
        
        # Test 1: Load main data
        try:
            df = pd.read_csv('data/raw/ethiopia_fi_unified_data.csv')
            print(f'‚úÖ Main data loaded: {df.shape[0]} rows, {df.shape[1]} columns')
        except Exception as e:
            print(f'‚ùå Main data loading failed: {e}')
            sys.exit(1)
            
        # Test 2: Load reference codes
        try:
            ref_df = pd.read_csv('data/raw/reference_codes.csv')
            print(f'‚úÖ Reference data loaded: {ref_df.shape[0]} rows, {ref_df.shape[1]} columns')
        except Exception as e:
            print(f'‚ùå Reference data loading failed: {e}')
            sys.exit(1)
            
        # Test 3: Check required columns exist
        required_columns = ['record_id', 'record_type', 'value_numeric', 'observation_date']
        missing = [col for col in required_columns if col not in df.columns]
        if missing:
            print(f'‚ùå Missing required columns: {missing}')
            sys.exit(1)
        else:
            print('‚úÖ All required columns present')
            
        print('üéâ All tests passed!')
        "
    
    - name: Run basic Python tests (if any)
      run: |
        if [ -f "tests/test_basic.py" ]; then
          python -m pytest tests/test_basic.py -v
        else
          echo "No test files found, skipping pytest"
        fi